<!-- 일반 사용자 뷰 -->
<div class="mb-4 flex items-center space-x-2">
  <span class="{{ 'bg-gray-100 text-gray-600' if study.is_closed else 'bg-blue-100 text-blue-800' }} text-sm px-2 py-1 rounded-full"
    >{{ study.subject }}</span
  >
  {% if study.is_closed %}
  <span class="bg-red-100 text-red-800 text-xs font-medium px-2 py-1 rounded-full">
    마감
  </span>
  {% else %}
  <span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded-full">
    모집중
  </span>
  {% endif %}
</div>

<div class="mb-4">
  <h3 class="text-sm font-medium text-gray-700 mb-2">스터디 설명</h3>
  <p class="text-gray-600 text-sm">{{ study.description }}</p>
</div>

<div class="space-y-3 mb-6">
  <div class="flex items-center justify-between text-sm">
    <span class="text-gray-500">최대 참여자</span>
    <span class="font-medium">{{ study.max_participants }}명</span>
  </div>

  {% if study.study_date %}
  <div class="flex items-center justify-between text-sm">
    <span class="text-gray-500">스터디 일정</span>
    <span class="font-medium">{{ to_datetime_str(study.study_date) }}</span>
  </div>
  {% endif %} {% if study.candidate %}
  <div class="text-sm {{ 'opacity-50' if study.is_closed else '' }}">
    <span class="text-gray-500 mb-2 block">
      {% if study.is_closed %}
        참여 신청이 마감되었습니다
      {% else %}
        참여 가능한 날짜를 선택하세요
      {% endif %}
    </span>
    <div class="space-y-2" id="date-selection">
      {% set unique_dates = [] %} {% for candidate in study.candidate %} {% if
      candidate.date not in unique_dates %} {% set _ =
      unique_dates.append(candidate.date) %} {% endif %} {% endfor %} {% for
      date in unique_dates %}
      <label class="flex items-center space-x-2 {{ 'cursor-not-allowed' if study.is_closed else 'cursor-pointer' }}">
        <input
          type="checkbox"
          name="selected_dates"
          value="{{ date }}"
          class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
          {{ 'disabled' if study.is_closed else '' }}
        />
        <span class="font-medium {{ 'text-gray-400' if study.is_closed else '' }}">{{ to_datetime_str(date) }}</span>
      </label>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="flex items-center justify-between text-sm">
    <span class="text-gray-500">확정 참여자</span>
    <span class="font-medium">{{ study.confirmed_candidate|length }}명</span>
  </div>
</div>

{% if study.is_closed %}
<button
  type="button"
  class="w-full bg-gray-400 text-gray-600 py-2 px-4 rounded-lg text-sm font-medium cursor-not-allowed"
  disabled
>
  참여 신청 마감
</button>
{% else %}
<button
  type="button"
  class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg text-sm font-medium"
  onclick="applyToStudy('{{ study.id }}')"
>
  스터디 참여하기
</button>
{% endif %}

<script>
  async function applyToStudy(studyId) {
    const selectedDates = [];
    const checkboxes = document.querySelectorAll(
      ' input[name="selected_dates" ]:checked'
    );
    checkboxes.forEach((checkbox) => {
      selectedDates.push(checkbox.value);
    });
    if (selectedDates.length === 0) {
      alert("참여하고 싶은 날짜를 선택해주세요.");
      return;
    }
    try {
      const response = await fetch(`/study/${studyId}/apply`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest",
        },
        body: JSON.stringify({ selected_dates: selectedDates }),
      });
      if (response.ok) {
        alert("스터디 참여 신청이 완료되었습니다!");
        closeDetail();
      } else {
        const errorText = await response.text();
        alert(`신청 실패: ${errorText}`);
      }
    } catch (error) {
      console.error("스터디 신청 오류:", error);
      alert("신청 중 오류가 발생했습니다. 다시 시도해주세요.");
    }
  }
</script>
