<!-- templates/room.html -->
<!DOCTYPE html>
<html>
  <head>
    <title>Room {{ room_id }}</title>
    <link rel="shortcut icon" href="#" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body>
    <h2>Room: {{ room_id }}</h2>
    <div
      id="videos"
      class="flex flex-wrap justify-center items-start gap-2 p-2 max-h-[90vh] overflow-y-auto border border-gray-300 rounded-lg"
    >
      <div class="video-wrapper flex-auto">
        <div class="col ps-5 pt-5" id="screenshare-container" hidden>
          <div class="row">
            <div class="col">
              <h2>Screen Shared Stream</h2>
            </div>
          </div>
          <div class="row p-3">
            <video
              height="300"
              id="screenshared-video"
              controls
              class="local-video"
            ></video>
          </div>
          <!-- <div class="row">
                    <div class="col-3 col-sm-12"><button type="submit" class="btn btn-success mb-3"
                            onclick="startScreenShare()">Share Screen</button>
                    </div>
                </div> -->
        </div>
        <video
          id="localVideo"
          autoplay
          playsinline
          muted
          class="rounded-lg bg-black"
        ></video>
      </div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="inputs">
      <input
        type="text"
        rows="3"
        placeholder="메세지"
        name="message"
        id="message"
      />
      <button type="button" name="send" id="send-btn" onclick="sendMessage()">
        보내기
      </button>

      <button type="button" name="send" id="share-btn" onclick="shareScreen()">
        화면공유
      </button>
    </div>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
      const socketio = io();
      const room = "{{ room_id }}";
      const peers = {};
      const videoContainer = document.getElementById("videos");
      // var screenSharing = false;
      const shareBtn = document.getElementById("share-btn");

      let localStream;
      async function start() {
        localStream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true,
        });
        document.getElementById("localVideo").srcObject = localStream;
        socketio.emit("join", { room });
      }
      start();

      socketio.on("user-joined", async ({ userId }) => {
        const peer = createPeer(userId);
        peers[userId] = peer;

        const offer = await peer.createOffer();
        await peer.setLocalDescription(offer);
        socketio.emit("signal", { room, offer, to: userId });
        adjustVideoSizes();
      });

      socketio.on("signal", async (data) => {
        const { from, offer, answer, candidate } = data;
        if (!peers[from]) {
          peers[from] = createPeer(from);
        }
        const peer = peers[from];

        if (offer) {
          await peer.setRemoteDescription(new RTCSessionDescription(offer));
          const answerDesc = await peer.createAnswer();
          await peer.setLocalDescription(answerDesc);
          socketio.emit("signal", { room, answer: answerDesc, to: from });
        } else if (answer) {
          await peer.setRemoteDescription(new RTCSessionDescription(answer));
        } else if (candidate) {
          await peer.addIceCandidate(new RTCIceCandidate(candidate));
        }
      });

      function createPeer(userId) {
        const peer = new RTCPeerConnection();

        localStream
          .getTracks()
          .forEach((track) => peer.addTrack(track, localStream));

        peer.ontrack = (event) => {
          let container = document.getElementById("container-" + userId);
          if (!container) {
            container = document.createElement("div");
            container.id = "container-" + userId;
            container.className = "video-wrapper flex-auto"; // responsive width
            const video = document.createElement("video");
            video.id = "video-" + userId;
            video.autoplay = true;
            video.playsinline = true;
            video.srcObject = event.streams[0];
            video.className = "w-full h-auto rounded-lg bg-black";
            container.appendChild(video);

            videoContainer.appendChild(container);
          }
        };

        peer.onicecandidate = (event) => {
          if (event.candidate) {
            socketio.emit("signal", {
              room,
              candidate: event.candidate,
              to: userId,
            });
          }
        };

        return peer;
      }

      socketio.on("user-left", ({ userId }) => {
        deletePeerVideo(userId);
      });

      function deletePeerVideo(userId) {
        // Find the video element for this peer
        const video = document.getElementById("video-" + userId);

        // Remove it from the DOM if it exists
        if (video) {
          video.srcObject = null; // stop the stream
          video.remove();
        }
        adjustVideoSizes();
      }

      // 메세지 보내기
      const messages = document.getElementById("messages");

      const createMessage = (msg) => {
        const content = `
            <div class="text">
                <span>
                    <strong>이름</strong>: ${msg}
                </span>
                <span class="muted">
                    ${new Date().toLocaleString()}
                </span>
            </div>
            `;
        messages.innerHTML += content;
      };

      socketio.on("message", (data) => {
        createMessage(data.message);
      });

      const sendMessage = () => {
        const message = document.getElementById("message");
        if (message.value == "") return;
        socketio.emit("message", { data: message.value });
        message.value = "";
      };

      // function

      function createShare(userId) {
        const peer = new RTCPeerConnection();

        localStream
          .getTracks()
          .forEach((track) => peer.addTrack(track, localStream));

        peer.ontrack = (event) => {
          let container = document.getElementById("container-" + userId);
          if (!container) {
            container = document.createElement("div");
            container.id = "container-" + userId;
            container.className = "video-wrapper flex-auto"; // responsive width
            const video = document.createElement("video");
            video.id = "video-" + userId;
            video.autoplay = true;
            video.playsinline = true;
            video.srcObject = event.streams[0];
            video.className = "w-full h-auto rounded-lg bg-black";
            container.appendChild(video);

            videoContainer.appendChild(container);
          }
        };

        peer.onicecandidate = (event) => {
          if (event.candidate) {
            socketio.emit("signal", {
              room,
              candidate: event.candidate,
              to: userId,
            });
          }
        };

        return peer;
      }
    </script>
  </body>
</html>
