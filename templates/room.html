<!-- templates/room.html -->
<!DOCTYPE html>
<html lang="ko">
  <head>
    <title>Room {{ room_id }}</title>
    <link rel="shortcut icon" href="#" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-800 text-white font-sans m-0 p-0">
    <div
      id="videos"
      class="w-full h-[80vh] my-[10vh] bg-gray-700 flex justify-center items-center rounded-lg overflow-hidden"
    >
      <div class="video-wrapper flex-auto">
        <video
          id="localVideo"
          autoplay
          playsinline
          muted
          class="rounded-lg bg-black video-custom"
        ></video>
      </div>
    </div>
    <div
      class="fixed bottom-5 right-5 bg-blue-600 text-white text-2xl p-4 rounded-full cursor-pointer shadow-lg z-[1000]"
      id="chat-icon"
    >
      ğŸ’¬
    </div>
    <div
      class="fixed bottom-20 right-5 max-h-96 bg-gray-700 rounded-lg shadow-xl hidden flex-col overflow-hidden z-[1001]"
      id="chat-box"
    >
      <div
        class="flex-1 p-2.5 overflow-y-auto border-b border-gray-600 text-white"
        id="messages"
      ></div>
      <div class="flex border-t border-gray-600">
        <input
          type="text"
          rows="3"
          placeholder="ë©”ì„¸ì§€"
          name="message"
          id="message"
          class="flex-1 p-2.5 border-0 outline-0 bg-gray-600 text-white"
        />
        <button
          type="button"
          name="send"
          id="send-btn"
          onclick="sendMessage()"
          class="p-2.5 bg-blue-600 text-white border-0 cursor-pointer"
        >
          ë³´ë‚´ê¸°
        </button>
      </div>
    </div>
    <h2
      class="text-xl font-bold text-white bg-gray-600 py-2.5 px-4 rounded-lg fixed bottom-5 left-5 z-[1000] shadow-lg"
    >
      ë°© ì•„ì´ë””: {{ room_id }} // {{username}}
    </h2>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
      const socketio = io();
      const room = "{{ room_id }}";
      const peers = {};
      const videoContainer = document.getElementById("videos");
      // var screenSharing = false;
      const shareBtn = document.getElementById("share-btn");
      let localStream;

      async function start() {
        // ê¸°ë³¸ ìë°”ìŠ¤í¬ë¦½íŠ¸ í•¨ìˆ˜ -- ì¹´ë©”ë¼ì™€ ë§ˆì´í¬ ìŠ¤íŠ¸ë¦¼ì„ í™œì„±í™”
        localStream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true,
        });

        // ë¡œì»¬ ë¹„ë””ì˜¤ ìš”ì†Œì—ë§Œ í˜„ì¬ ìŠ¤íŠ¸ë¦¼ í‘œì‹œ
        document.getElementById("localVideo").srcObject = localStream;

        // ì†Œì¼“ì„ í†µí•´ ë¡œì»¬ ì‚¬ìš©ìì˜ ì •ë³´ ì „ë‹¬- app.py / @socketio.on("join")ë¡œ ì´ë™
        socketio.emit("join", { room });
      }
      start();

      // ë‹¤ë¥¸ ìœ ì €ë“¤í•œí…Œ ìƒˆë¡œìš´ userIdë¡œ RTC ìƒì„±
      socketio.on("user-joined", async ({ userId }) => {
        // ìƒˆë¡œìš´ RTCConnection ìƒì„±
        const peer = createPeer(userId);

        // peer ë ˆí¼ë ŒìŠ¤ìš© í•¨ìˆ˜ --
        peers[userId] = peer;

        // WebRTC ìƒì„± -  Peer ì„œë¡œê°„ì˜ ë¯¸ë””ì–´ì™€ ë„¤íŠ¸ì›Œí¬ì— ê´€í•œ ì •ë³´ë¥¼ ì´í•´í•˜ê¸° ìœ„í•´ ì‚¬ìš© -- session ID, session version ë“±ë“± í¬í•¨
        const offer = await peer.createOffer();

        // ì›ê²© í”¼ì–´ì—ê²Œ ì „ì†¡í•  ë¡œì»¬ ì„¤ëª… ì„¤ì • - ë¯¸ë””ì–´í¬ë§· ** / promise í•¨ìˆ˜
        await peer.setLocalDescription(offer);

        // app.py - @socketio.on("signal")ë¡œ ì´ë™
        socketio.emit("signal", { room, offer, to: userId });
      });

      socketio.on("signal", async (data) => {
        const { from, offer, answer, candidate } = data;
        if (!peers[from]) {
          peers[from] = createPeer(from);
        }
        const peer = peers[from];

        // ë‹¤ë¥¸ ì‚¬ìš©ìë¡œë¶€í„° ìƒˆ ì—°ê²° ìš”ì²­(offer) ìˆ˜ì‹ , ë‹µì¥ ë°œì‹ 
        if (offer) {
          await peer.setRemoteDescription(new RTCSessionDescription(offer));
          const answerDesc = await peer.createAnswer();
          await peer.setLocalDescription(answerDesc);
          socketio.emit("signal", { room, answer: answerDesc, to: from });
          // ë‹¤ë¥¸ ì‚¬ìš©ìì—ê²Œì„œ ì—°ê²° ì‘ë‹µ(answer) ìˆ˜ì‹ 
        } else if (answer) {
          await peer.setRemoteDescription(new RTCSessionDescription(answer));
          // ë‹¤ë¥¸ ì‚¬ìš©ìì—ê²Œì„œ ICE í›„ë³´(candidate) ìˆ˜ì‹ 
        } else if (candidate) {
          await peer.addIceCandidate(new RTCIceCandidate(candidate));
        }
      });

      function createPeer(userId) {
        const peer = new RTCPeerConnection();

        // ë¯¸ë””ì–´ íŒŒì¼ì„ ë‹¤ë¥¸ ìœ ì €ë¡œ ë°œì‹ 
        localStream
          .getTracks()
          .forEach((track) => peer.addTrack(track, localStream));

        // ë‹¤ë¥¸ ì‚¬ìš©ìì—ê²Œì„œ ë¯¸ë””ì–´ íŒŒì¼ ìˆ˜ì‹ 
        peer.ontrack = (event) => {
          let container = document.getElementById("container-" + userId);
          if (!container) {
            container = document.createElement("div");
            container.id = "container-" + userId;
            container.className = "video-wrapper flex-auto video-custom"; // responsive width
            const video = document.createElement("video");
            video.id = "video-" + userId;
            video.autoplay = true;
            video.playsinline = true;
            video.srcObject = event.streams[0];
            video.className = "w-full h-auto rounded-lg bg-black";
            container.appendChild(video);
            videoContainer.appendChild(container);
          }
        };

        peer.onicecandidate = (event) => {
          if (event.candidate) {
            socketio.emit("signal", {
              room,
              candidate: event.candidate,
              to: userId,
            });
          }
        };

        return peer;
      }

      socketio.on("user-left", ({ userId }) => {
        deletePeerVideo(userId);
      });

      function deletePeerVideo(userId) {
        const video = document.getElementById("video-" + userId);

        // DOMì—ì„œ ì”ì—¬ ë¹„ë””ì˜¤ ìš”ì†Œê°€ ì¡´ì¬í•˜ë©´ ì œê±°
        if (video) {
          video.srcObject = null; // í™”ë©´ê³µìœ  ì¢…ë£Œ
          video.remove(); // ë¹„ë””ì˜¤ ì‚­ì œ
          peers[userId].close(); // peer ì—°ê²° ì‚­ì œ
          delete peers[userId]; // peer ë ˆí¼ëŸ°ìŠ¤ ì‚­ì œ
        }
      }

      // // ë©”ì„¸ì§€ ë³´ë‚´ê¸°
      const messages = document.getElementById("messages");

      const createMessage = (name, msg) => {
        const formattedTime = new Date().toLocaleString("ko-KR", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });

        const content = `
                <div class="text" style="margin-bottom: 8px">
                  <span class="muted" style="font-size: 0.8em; display: block; margin-bottom: 2px;">
                      ${formattedTime}
                  </span>
                  <span>
                      <strong>${name}</strong>: ${msg}
                  </span>
              </div>
            `;
        messages.innerHTML += content;
      };

      socketio.on("message", (data) => {
        createMessage(data.name, data.message);
      });

      const sendMessage = () => {
        const message = document.getElementById("message");
        if (message.value == "") return;
        socketio.emit("message", { data: message.value });
        message.value = "";
      };

      const chatIcon = document.getElementById("chat-icon");
      const chatBox = document.getElementById("chat-box");

      chatIcon.addEventListener("click", () => {
        chatBox.style.display =
          chatBox.style.display === "flex" ? "none" : "flex";
        chatBox.style.flexDirection = "column";
      });

      socketio.on("duplicate_login", () => {
        alert("ì¤‘ë³µ ë¡œê·¸ì¸ìœ¼ë¡œ ì ‘ì†ì´ ì¢…ë£Œë©ë‹ˆë‹¤.");
        window.location.href = "/error";
      });
    </script>
  </body>
</html>
